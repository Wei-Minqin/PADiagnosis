{% extends 'index.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}上传CT图像 - 盆腹腔诊断系统{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'diagnosis:home' %}">盆腹腔诊断</a></li>
<li class="breadcrumb-item active" aria-current="page">上传CT图像</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">
            <i class="bi bi-clipboard-pulse me-2"></i> 盆腹腔多模态诊断
        </h2>
        <div>
            <a href="{% url 'diagnosis:home' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> 返回
            </a>
        </div>
    </div>
    
    <!-- 患者信息卡片 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-person-badge me-2"></i> 患者信息</span>
        </div>
        <div class="card-body">
            {% if patient_info %}
            <input type="hidden" id="id_patient" name="patient_id" value="{{ patient_info.patient_id }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex gap-3">
                        <div class="patient-avatar bg-light rounded-circle d-flex justify-content-center align-items-center" style="width: 80px; height: 80px;">
                            <i class="bi bi-file-earmark-medical text-primary" style="font-size: 2.5rem;"></i>
                        </div>
                        <div class="patient-info">
                            <h4 class="mb-1">患者ID: {{ patient_info.patient_id }}
                                {% if patient %}
                                <small class="text-muted">
                                    ({{ patient.name }} - {% if patient.clinical_features %}{{ patient.clinical_features.age }}{% else %}{{ patient.get_age }}{% endif %}岁)
                                </small>
                                {% endif %}
                            </h4>
                            <p class="mb-1 text-muted">图像类型: {{ patient_info.image_style }}</p>
                            <div class="badge 
                                {% if patient_info.image_style == 'US' %}bg-success
                                {% elif patient_info.image_style == 'CT' %}bg-primary
                                {% elif patient_info.image_style == 'MRI' %}bg-warning
                                {% else %}bg-info
                                {% endif %}">{{ patient_info.image_style }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item mb-2">
                                <div class="info-label text-muted">上传时间</div>
                                <div class="info-value">{{ patient_info.created_at|date:"Y-m-d H:i" }}</div>
                            </div>
                            <div class="info-item mb-2">
                                <div class="info-label text-muted">创建医生</div>
                                <div class="info-value">{{ patient_info.created_by.full_name }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if patient and patient.clinical_features %}
                            <div class="info-item mb-2">
                                <div class="info-label text-muted">体温</div>
                                {% with cf=patient.clinical_features %}
                                <div class="info-value text-{{ cf.body_temperature|temp_status|cut:'status-' }} fw-semibold">{{ cf.body_temperature }}°C</div>
                                {% endwith %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 临床特征数据 -->
            {% if clinical_features %}
            <div class="mt-4">
                <h5 class="border-bottom pb-2 mb-3">临床特征数据</h5>
                <div class="row">
                    <!-- 实际临床数据将根据patient.clinical_features动态显示 -->
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            临床特征数据已加载，请上传CT图像进行分析。
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                未找到患者图像信息。请返回<a href="{% url 'diagnosis:home' %}" class="alert-link">诊断首页</a>选择一个患者图像进行诊断。
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 诊断操作卡片 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-clipboard-check me-2"></i> 诊断操作</span>
        </div>
        <div class="card-body">
            <div class="text-center py-4">
                <div class="mb-4">
                    <i class="bi bi-clipboard2-pulse text-primary" style="font-size: 3rem;"></i>
                </div>
                <h5 class="mb-3">盆腹腔多模态诊断</h5>
                <p class="text-muted mb-4">系统将使用患者的医学图像数据进行智能诊断分析</p>
                
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                        <i class="bi bi-arrow-left me-1"></i> 返回
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" id="diagnosisButton">
                        <i class="bi bi-clipboard-pulse me-1"></i> 开始诊断
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 诊断结果模态框 -->
<div class="modal fade" id="diagnosisResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">盆腹腔诊断结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="spinner-border text-primary" role="status" id="diagnosisSpinner">
                        <span class="visually-hidden">正在诊断中...</span>
                    </div>
                    
                    <div id="diagnosisResult" style="display: none;">
                        <div class="result-icon mb-3">
                            <i class="bi bi-clipboard-check text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h4 class="mb-3">诊断完成</h4>
                        
                        <div class="row justify-content-center mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">最终诊断结果</h5>
                                        <div class="diagnosis-results-grid mb-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">无外伤</div>
                                        <div class="diagnosis-confidence" id="confidence-0">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">腹盆腔或腹膜后积血/血肿</div>
                                        <div class="diagnosis-confidence" id="confidence-1">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">肝脏损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-2">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">脾脏损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-3">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">右肾损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-4">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">左肾损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-5">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">右肾上腺损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-6">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="diagnosis-item">
                                        <div class="diagnosis-label">胰腺损伤</div>
                                        <div class="diagnosis-confidence" id="confidence-7">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="diagnosis-summary p-3 bg-light rounded">
                            <p class="mb-2"><strong>综合诊断结果：</strong><span id="final-diagnosis">诊断中...</span></p>
                            <p class="mb-0"><strong>数据来源：</strong><span id="page-data-source" class="badge bg-secondary ms-2">诊断中...</span></p>
                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i> 诊断结果仅供医生参考，最终诊断结果请以医生判断为准。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="saveResultButton" style="display: none;">保存结果</button>
            </div>
        </div>
    </div>
</div>

<!-- 加载中模态框 -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="false" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">正在加载...</span>
                </div>
                <h5 class="mb-2">正在分析中</h5>
                <p class="mb-0 text-muted">系统正在分析患者临床特征数据，请稍候...</p>
            </div>
        </div>
    </div>
</div>

<!-- 增加一个运行状态指示器 -->
<div id="diagnosis-loading" class="modal fade" tabindex="-1" aria-labelledby="diagnosisLoadingLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="diagnosisLoadingLabel">正在进行诊断</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="mb-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">诊断中...</span>
                    </div>
                    <p class="mt-3">正在进行诊断，请稍候...</p>
                    <div id="loading-time" class="text-muted small">已等待 0 秒</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 诊断结果模态框 -->
<div id="diagnosisResultModal" class="modal fade" tabindex="-1" aria-labelledby="diagnosisResultLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="diagnosisResultLabel">诊断结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div id="diagnosisSpinner" class="text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">诊断中...</span>
                    </div>
                    <p>正在分析诊断结果...</p>
                </div>
                
                <div id="diagnosisResult" style="display: none;">
                    <div class="diagnosis-results-grid mb-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">无外伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-0">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">腹盆腔或腹膜后积血/血肿</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-1">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">肝脏损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-2">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">脾脏损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-3">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">右肾损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-4">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">左肾损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-5">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">右肾上腺损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-6">0%</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="diagnosis-item">
                                    <div class="diagnosis-label">胰腺损伤</div>
                                    <div class="diagnosis-confidence" id="modal-confidence-7">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="diagnosis-summary p-3 bg-light rounded mb-3">
                        <p class="mb-2"><strong>综合诊断结果：</strong><span id="modal-final-diagnosis">诊断中...</span></p>
                        <p class="mb-0"><strong>数据来源：</strong><span id="modal-data-source" class="badge bg-secondary ms-2">诊断中...</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="saveResultButton" style="display: none;">保存结果</button>
            </div>
        </div>
    </div>
</div>

{% block page_styles %}
<style>
    .text-normal {
        color: #198754;
    }
    
    .text-warning {
        color: #FFC107;
    }
    
    .text-danger {
        color: #DC3545;
    }
    
    .upload-area {
        min-height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .upload-area:hover {
        border-color: #2B5DE0;
        cursor: pointer;
    }
    
    .info-label {
        font-size: 0.85rem;
    }
    
    .info-value {
        font-size: 1rem;
    }
    
    .clinical-item {
        font-size: 0.9rem;
    }
    
    /* 诊断结果样式 */
    .diagnosis-item {
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: #f8f9fa;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .diagnosis-item:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .diagnosis-item.high-confidence {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .diagnosis-item.medium-confidence {
        border-color: #ffc107;
        background: #fff3cd;
    }
    
    .diagnosis-item.low-confidence {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .diagnosis-label {
        font-size: 14px;
        color: #333;
        margin-bottom: 10px;
        font-weight: 500;
    }
    
    .diagnosis-confidence {
        font-size: 20px;
        font-weight: bold;
        color: #007bff;
        text-align: center;
    }
    
    .diagnosis-item.high-confidence .diagnosis-confidence {
        color: #dc3545;
    }
    
    .diagnosis-item.medium-confidence .diagnosis-confidence {
        color: #ffc107;
    }
    
    .diagnosis-item.low-confidence .diagnosis-confidence {
        color: #28a745;
    }
</style>
{% endblock %}

{% block page_scripts %}
<!-- jQuery已在base模板中引用，无需重复引用 -->
<script>
    $(document).ready(function() {
        // 监听所有模态框隐藏事件，确保背景遮罩被完全清除
        $('#diagnosisResultModal, #loadingModal, #diagnosis-loading').on('hidden.bs.modal', function() {
            // 移除可能残留的模态框背景
            $('.modal-backdrop').remove();
            
            // 移除body上的modal-open类
            $('body').removeClass('modal-open');
            $('body').css({
                'overflow': '',
                'padding-right': ''
            });
        });
        
        // 诊断按钮点击事件
        $('#diagnosisButton').click(function() {
            startDiagnosis();
        });
        
        // 开始诊断函数
        function startDiagnosis() {
            $('#diagnosisButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>诊断中...');
            
            // 显示诊断中弹窗
            var diagnosisLoadingModal = new bootstrap.Modal(document.getElementById('diagnosis-loading'));
            diagnosisLoadingModal.show();
            
            // 初始化等待计时
            let waitSeconds = 0;
            $('#loading-time').text(`已等待 ${waitSeconds} 秒`);
            
            // 启动计时器
            let waitTimer = setInterval(function() {
                waitSeconds++;
                $('#loading-time').text(`已等待 ${waitSeconds} 秒`);
            }, 1000);
            
            // 准备请求数据
            let requestData = {
                'patient_id': '{{ patient_info.patient_id }}'
            };
            
            $.ajax({
                url: '{% url "diagnosis:ajax_diagnose" %}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    // 清除计时器
                    clearInterval(waitTimer);
                    
                    // 隐藏诊断中弹窗
                    diagnosisLoadingModal.hide();
            
                    if (response.success) {
                        // 显示诊断结果模态框
                        $('#diagnosisSpinner').hide();
                        $('#diagnosisResult').show();
                        $('#saveResultButton').show();
                        
                        // 8种外伤类型的置信度字段名
                         const confidenceFields = [
                             'confidence_0', 'confidence_1', 'confidence_2', 'confidence_3',
                             'confidence_4', 'confidence_5', 'confidence_6', 'confidence_7'
                         ];
                         
                         // 外伤类型名称
                         const injuryNames = [
                             '无外伤', '腹盆腔或腹膜后积血/血肿', '肝脏损伤', '脾脏损伤',
                             '右肾损伤', '左肾损伤', '右肾上腺损伤', '胰腺损伤'
                         ];
                         
                         let maxConfidence = 0;
                         let maxIndex = 0;
                         
                         // 更新模态框中的每个置信度显示
                         confidenceFields.forEach((field, index) => {
                             const confidence = response.confidences[field] || 0;
                             const confidenceElement = document.getElementById(`modal-confidence-${index}`);
                             
                             if (confidenceElement) {
                                 const percentage = Math.round(confidence);
                                 confidenceElement.textContent = percentage + '%';
                                 
                                 // 根据置信度设置样式
                                 const item = confidenceElement.closest('.diagnosis-item');
                                 item.classList.remove('high-confidence', 'medium-confidence', 'low-confidence');
                                 
                                 if (percentage >= 70) {
                                     item.classList.add('high-confidence');
                                 } else if (percentage >= 30) {
                                     item.classList.add('medium-confidence');
                                 } else if (percentage > 0) {
                                     item.classList.add('low-confidence');
                                 }
                                 
                                 // 找到最高置信度
                                 if (confidence > maxConfidence) {
                                     maxConfidence = confidence;
                                     maxIndex = index;
                                 }
                             }
                         });
                         
                         // 更新模态框中的综合诊断结果
                         const modalFinalDiagnosis = document.getElementById('modal-final-diagnosis');
                         if (modalFinalDiagnosis) {
                             const maxPercentage = Math.round(maxConfidence);
                             modalFinalDiagnosis.textContent = `${injuryNames[maxIndex]} (置信度: ${maxPercentage}%)`;
                         }
                         
                         // 同时更新页面上的诊断结果显示
                         confidenceFields.forEach((field, index) => {
                             const confidence = response.confidences[field] || 0;
                             const confidenceElement = document.getElementById(`confidence-${index}`);
                             
                             if (confidenceElement) {
                                 const percentage = Math.round(confidence);
                                 confidenceElement.textContent = percentage + '%';
                                 
                                 // 根据置信度设置样式
                                 const item = confidenceElement.closest('.diagnosis-item');
                                 item.classList.remove('high-confidence', 'medium-confidence', 'low-confidence');
                                 
                                 if (percentage >= 70) {
                                     item.classList.add('high-confidence');
                                 } else if (percentage >= 30) {
                                     item.classList.add('medium-confidence');
                                 } else if (percentage > 0) {
                                     item.classList.add('low-confidence');
                                 }
                             }
                         });
                         
                         // 更新页面上的综合诊断结果
                         const finalDiagnosis = document.getElementById('final-diagnosis');
                         if (finalDiagnosis) {
                             const maxPercentage = Math.round(maxConfidence);
                             finalDiagnosis.textContent = `${injuryNames[maxIndex]} (置信度: ${maxPercentage}%)`;
                         }
                         
                         // 显示数据来源标识
                         const dataSourceLabel = response.data_source_label || '未知数据源';
                         const dataSource = response.data_source || 'unknown';
                         
                         // 更新模态框中的数据来源显示
                         const modalDataSource = document.getElementById('modal-data-source');
                         if (modalDataSource) {
                             modalDataSource.innerHTML = `<i class="bi bi-${dataSource === 'model' ? 'cpu' : 'gear'} me-1"></i> ${dataSourceLabel}`;
                             modalDataSource.className = `badge ${dataSource === 'model' ? 'bg-success' : 'bg-warning'} ms-2`;
                         }
                         
                         // 更新页面上的数据来源显示
                         const pageDataSource = document.getElementById('page-data-source');
                         if (pageDataSource) {
                             pageDataSource.innerHTML = `<i class="bi bi-${dataSource === 'model' ? 'cpu' : 'gear'} me-1"></i> ${dataSourceLabel}`;
                             pageDataSource.className = `badge ${dataSource === 'model' ? 'bg-success' : 'bg-warning'} ms-2`;
                         }
                        
                        // 显示模态框
                        var diagnosisModal = new bootstrap.Modal(document.getElementById('diagnosisResultModal'));
                        diagnosisModal.show();
                        
                        // 恢复诊断按钮状态
                        $('#diagnosisButton').prop('disabled', false).html('<i class="bi bi-clipboard-pulse me-1"></i> 开始诊断');
                        
                        // 保存结果按钮点击跳转
                        $('#saveResultButton').off('click').on('click', function() {
                            window.location.href = `/diagnosis/result/${response.diagnosis_id}/`;
                        });
                    } else {
                        alert('诊断失败: ' + response.error);
                        $('#diagnosisButton').prop('disabled', false).html('<i class="bi bi-clipboard-pulse me-1"></i> 开始诊断');
                    }
                },
                error: function(xhr) {
                    // 清除计时器
                    clearInterval(waitTimer);
                    
                    // 隐藏诊断中弹窗
                    diagnosisLoadingModal.hide();
                    
                    let errorMsg = '诊断失败';
                    try {
                        errorMsg = JSON.parse(xhr.responseText).error || errorMsg;
                    } catch (e) {}
                    
                    alert(errorMsg);
                    $('#diagnosisButton').prop('disabled', false).html('<i class="bi bi-clipboard-pulse me-1"></i> 开始诊断');
                }
            });
        }
    });
</script>
{% endblock %}

{% endblock %}